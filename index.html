<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>MemoryPro | ç»ˆæè¿›åŒ–ç‰ˆ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --xp-bar-bg: #e0e7ff;
            --xp-bar-fill: linear-gradient(90deg, #6366f1, #ec4899);
        }

        [data-theme="dark"] {
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-main: #f9fafb;
            --text-sub: #9ca3af;
            --border: #374151;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            --xp-bar-bg: #374151;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-main); height: 100vh; overflow: hidden; transition: background-color 0.3s; }

        .app-container { display: flex; height: 100%; max-width: 1600px; margin: 0 auto; }

        /* Sidebar */
        .sidebar { width: 320px; background-color: var(--card-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: all 0.3s; z-index: 20; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.25rem; font-weight: 800; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Player Stats (Gamification) */
        .player-profile { padding: 15px 20px; border-bottom: 1px solid var(--border); background: linear-gradient(to right, rgba(99, 102, 241, 0.05), rgba(236, 72, 153, 0.05)); }
        .profile-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .level-badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }
        .currency { font-size: 0.9rem; color: var(--warning); font-weight: bold; display: flex; align-items: center; gap: 4px; }
        .streak-badge { font-size: 0.9rem; color: var(--danger); font-weight: bold; display: flex; align-items: center; gap: 4px; }

        .xp-container { width: 100%; height: 8px; background: var(--xp-bar-bg); border-radius: 4px; overflow: hidden; position: relative; }
        .xp-fill { height: 100%; background: var(--xp-bar-fill); width: 0%; transition: width 0.5s ease; }
        .xp-text { font-size: 0.7rem; color: var(--text-sub); margin-top: 4px; text-align: right; }

        /* Nav */
        .nav-menu { padding: 10px 20px; display: flex; flex-direction: column; gap: 8px; flex: 1; overflow-y: auto; }
        .nav-item { padding: 10px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: var(--text-sub); transition: all 0.2s; font-weight: 500; }
        .nav-item:hover { background-color: rgba(99, 102, 241, 0.1); color: var(--primary); }
        .nav-item.active { background-color: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }

        /* Heatmap */
        .heatmap-section { padding: 15px 20px; border-top: 1px solid var(--border); }
        .heatmap-grid { display: flex; gap: 3px; flex-wrap: wrap; justify-content: flex-start; margin-top: 10px; }
        .heatmap-cell { width: 10px; height: 10px; border-radius: 2px; background-color: var(--border); opacity: 0.3; }
        .level-1 { background-color: #c7d2fe; opacity: 1; }
        .level-2 { background-color: #818cf8; opacity: 1; }
        .level-3 { background-color: #4f46e5; opacity: 1; }
        .level-4 { background-color: #312e81; opacity: 1; }

        /* Main Area */
        .main-content { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; position: relative; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .icon-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--card-bg); color: var(--text-main); cursor: pointer; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: transform 0.2s; }
        .icon-btn:hover { transform: scale(1.1); color: var(--primary); }

        /* Flashcard */
        .workspace { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 500px; position: relative; }
        .flashcard-container { perspective: 1500px; width: 600px; height: 400px; margin-bottom: 20px; cursor: pointer; position: relative; z-index: 1; touch-action: none; }
        .flashcard { width: 100%; height: 100%; position: relative; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; border-radius: 24px; box-shadow: var(--shadow); background: var(--card-bg); }
        .flashcard.flipped { transform: rotateY(180deg); }

        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--card-bg); border-radius: 24px; padding: 40px; border: 1px solid var(--border); }
        .card-back { transform: rotateY(180deg); background: linear-gradient(145deg, var(--card-bg), rgba(99, 102, 241, 0.05)); }

        .word-title { font-size: 3rem; font-weight: 800; margin-bottom: 10px; text-align: center; }
        .phonetic { font-size: 1.2rem; color: var(--text-sub); font-family: serif; margin-bottom: 15px; }
        .meaning-text { font-size: 1.4rem; text-align: center; line-height: 1.6; margin-bottom: 20px; }
        .memory-tip { font-style: italic; color: var(--text-sub); border-top: 1px solid var(--border); padding-top: 15px; margin-top: auto; width: 100%; text-align: center; }
        .next-review-tip { font-size: 0.8rem; color: var(--text-sub); position: absolute; bottom: 20px; }

        /* External Links on Card Back */
        .external-links { display: flex; gap: 10px; margin-bottom: 15px; }
        .link-chip { font-size: 0.85rem; padding: 5px 12px; background: var(--bg-color); border-radius: 15px; color: var(--text-main); text-decoration: none; border: 1px solid var(--border); transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        .link-chip:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }

        /* Swipe Overlays */
        .swipe-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 24px; display: flex; align-items: center; justify-content: center; font-size: 4rem; color: white; opacity: 0; pointer-events: none; z-index: 10; transition: opacity 0.2s; }
        .overlay-left { background: rgba(239, 68, 68, 0.85); }
        .overlay-right { background: rgba(16, 185, 129, 0.85); }

        /* Controls */
        .controls { display: flex; gap: 15px; margin-top: 10px; z-index: 2; }
        .btn { padding: 12px 30px; border: none; border-radius: 50px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-outline { background: var(--card-bg); border: 1px solid var(--border); color: var(--text-main); }

        /* Modal & Toast */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: var(--shadow); max-height: 90vh; overflow-y: auto; }
        .upload-zone { border: 2px dashed var(--primary); border-radius: 15px; padding: 30px; text-align: center; margin: 15px 0; cursor: pointer; background: rgba(99, 102, 241, 0.05); }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.85); color: white; padding: 10px 20px; border-radius: 50px; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; font-size: 0.9rem; }
        .toast.show { opacity: 1; }

        /* Setting Item */
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .setting-item:last-child { border-bottom: none; }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -320px; height: 100%; box-shadow: 5px 0 20px rgba(0,0,0,0.2); }
            .sidebar.open { left: 0; }
            .flashcard-container { width: 90%; height: 55vh; }
            .word-title { font-size: 2.2rem; }
            .controls .btn span { display: none; } /* æ‰‹æœºç«¯åªæ˜¾ç¤ºå›¾æ ‡ */
            .controls .btn { padding: 15px; border-radius: 50%; }
            .stats-pill { display: none; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo"><i class="fas fa-cube"></i> MemoryPro</div>
                <button class="icon-btn" id="closeSidebarBtn" style="display: none;"><i class="fas fa-times"></i></button>
            </div>

            <div class="player-profile">
                <div class="profile-header">
                    <div class="level-badge" id="playerLevel">Lv.1 æ–°æ‰‹</div>
                    <div class="currency" title="é‡‘å¸"><i class="fas fa-coins"></i> <span id="playerCoins">0</span></div>
                    <div class="streak-badge" title="è¿ç»­æ‰“å¡"><i class="fas fa-fire"></i> <span id="playerStreak">0</span></div>
                </div>
                <div class="xp-container">
                    <div class="xp-fill" id="playerXpBar"></div>
                </div>
                <div class="xp-text"><span id="playerXp">0</span> / <span id="nextLevelXp">100</span> XP</div>
            </div>

            <div class="heatmap-section">
                <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:5px;">ğŸ”¥ å­¦ä¹ çƒ­åŠ› (è¿‘30å¤©)</div>
                <div class="heatmap-grid" id="heatmapGrid"></div>
            </div>

            <div class="nav-menu">
                <div class="nav-item active" data-mode="flashcard"><i class="fas fa-layer-group"></i> é—ªå¡å­¦ä¹ </div>
                <div class="nav-item" data-mode="review"><i class="fas fa-history"></i> æ™ºèƒ½å¤ä¹  <span id="badgeReview" style="margin-left:auto; background:var(--danger); color:white; padding:2px 6px; border-radius:10px; font-size:0.7rem; display:none;">0</span></div>
                <div class="nav-item" data-mode="quiz"><i class="fas fa-check-square"></i> å•è¯æµ‹è¯•</div>
                <div class="nav-item" data-mode="spelling"><i class="fas fa-keyboard"></i> æ‹¼å†™ç»ƒä¹ </div>
            </div>
        </div>

        <div class="main-content">
            <div class="top-bar">
                <button class="icon-btn" id="toggleSidebarBtn"><i class="fas fa-bars"></i></button>
                <div class="tools" style="display:flex; gap:10px;">
                    <button class="icon-btn" id="uploadBtn" title="åˆ‡æ¢è¯ä¹¦"><i class="fas fa-book"></i></button>
                    <button class="icon-btn" id="settingsBtn" title="è®¾ç½®ä¸å¤‡ä»½"><i class="fas fa-cog"></i></button>
                </div>
            </div>

            <div class="workspace" id="workspace">
                <div class="flashcard-container">
                    <div class="swipe-overlay overlay-left"><i class="fas fa-times"></i></div>
                    <div class="swipe-overlay overlay-right"><i class="fas fa-check"></i></div>

                    <div class="flashcard">
                        <div class="card-face card-front">
                            <button class="icon-btn" style="position:absolute; top:20px; right:20px;" onclick="speakWord(event)"><i class="fas fa-volume-up"></i></button>
                            <div class="word-title" id="cardWord">Loading...</div>
                            <div class="phonetic" id="cardPhonetic"></div>
                            <div style="margin-top:20px; opacity:0.7; font-size:0.9rem;">ç‚¹å‡»å¡ç‰‡æˆ–ç©ºæ ¼ç¿»é¢</div>
                            <div class="next-review-tip" id="cardNextReviewFront"></div>
                        </div>
                        <div class="card-face card-back">
                            <button class="icon-btn" style="position:absolute; top:20px; right:20px;" onclick="speakWord(event)"><i class="fas fa-volume-up"></i></button>
                            <div class="external-links" id="externalLinks">
                                </div>
                            <span style="background:var(--primary); color:white; padding:2px 8px; border-radius:4px; font-size:0.8rem;" id="cardPos"></span>
                            <div class="meaning-text" id="cardMeaning"></div>
                            <div class="memory-tip" id="cardMemory"></div>
                            <div class="next-review-tip" id="cardNextReviewBack"></div>
                        </div>
                    </div>
                </div>

                <div class="quiz-overlay" id="quizOverlay" style="display:none; width:100%; max-width:600px; background:var(--card-bg); padding:30px; border-radius:20px; box-shadow:var(--shadow); text-align:center;">
                    <h2>é€‰æ‹©æ­£ç¡®é‡Šä¹‰</h2>
                    <div class="word-title" id="quizWord" style="font-size:2rem; margin:20px 0;">Word</div>
                    <div style="display:grid; gap:15px;" id="quizOptions"></div>
                </div>

                <div class="spelling-overlay" id="spellingOverlay" style="display:none; width:100%; max-width:600px; background:var(--card-bg); padding:30px; border-radius:20px; box-shadow:var(--shadow); text-align:center;">
                    <button class="icon-btn" style="margin:0 auto 20px;" onclick="speakCurrentWord()"><i class="fas fa-volume-up"></i></button>
                    <div id="spellingMeaning" style="font-size:1.2rem; margin-bottom:20px;">Meaning</div>
                    <input type="text" id="spellingInput" style="font-size:2rem; padding:10px; text-align:center; width:80%; border:none; border-bottom:2px solid var(--border); background:transparent; color:var(--text-main); outline:none;">
                    <button class="btn btn-primary" style="margin:20px auto;" onclick="checkSpelling()">æ£€æŸ¥</button>
                </div>

                <div class="controls" id="flashcardControls">
                    <button class="btn btn-outline" id="btnPrev"><i class="fas fa-arrow-left"></i> <span>ä¸Šä¸ª</span></button>
                    <button class="btn btn-danger" id="btnUnknown"><i class="fas fa-times"></i> <span>å¿˜äº†</span></button>
                    <button class="btn btn-success" id="btnKnown"><i class="fas fa-check"></i> <span>è®°å¾—</span></button>
                    <button class="btn btn-outline" id="btnNext"><span>ä¸‹ä¸ª</span> <i class="fas fa-arrow-right"></i></button>
                </div>
                <div class="controls" style="margin-top:15px;">
                     <button class="btn btn-warning" id="btnMaster" style="font-size:0.9rem;">ğŸ‘‘ <span>æ°¸ä¹…æŒæ¡</span></button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="settingsModal">
        <div class="modal-content">
            <h2>âš™ï¸ è®¾ç½®ä¸å¤‡ä»½</h2>
            <div class="setting-item">
                <span>ğŸ”Š è‡ªåŠ¨å‘éŸ³ (ç¿»åˆ°æ–°å¡)</span>
                <label class="switch"><input type="checkbox" id="autoPlaySwitch"><span class="slider"></span></label>
            </div>
            <div class="setting-item">
                <span>ğŸŒ‘ æ·±è‰²æ¨¡å¼</span>
                <label class="switch"><input type="checkbox" id="darkModeSwitch"><span class="slider"></span></label>
            </div>

            <h3 style="margin-top:20px; font-size:1rem;">ğŸ’¾ æ•°æ®ç®¡ç†</h3>
            <p style="font-size:0.8rem; color:var(--text-sub); margin-bottom:10px;">å®šæœŸå¯¼å‡ºå¤‡ä»½ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼</p>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn btn-primary" style="justify-content:center;" onclick="exportData()"><i class="fas fa-download"></i> å¯¼å‡ºå¤‡ä»½</button>
                <button class="btn btn-outline" style="justify-content:center;" onclick="document.getElementById('backupInput').click()"><i class="fas fa-upload"></i> æ¢å¤å¤‡ä»½</button>
            </div>
            <input type="file" id="backupInput" accept=".json" hidden onchange="importData(this)">

            <div style="margin-top:30px; text-align:center;">
                <button class="btn btn-outline" onclick="document.getElementById('settingsModal').style.display='none'">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="uploadModal">
        <div class="modal-content">
            <h2>ğŸ“š è¯ä¹¦åŠ è½½</h2>
            <p id="uploadMsg" style="color: var(--text-sub); margin-bottom: 15px;">å°è¯•è¯»å– c.txt ...</p>
            <div class="upload-zone" id="dropZone">
                <i class="fas fa-file-import" style="font-size:2rem; color:var(--primary);"></i>
                <p style="margin-top:10px;">æœªæ‰¾åˆ° c.txtï¼Œè¯·æ‰‹åŠ¨æ‹–å…¥æ–‡ä»¶</p>
                <input type="file" id="fileInput" accept=".txt" hidden>
            </div>
            <button class="btn btn-outline" style="margin-top:20px;" onclick="document.getElementById('uploadModal').style.display='none'">å…³é—­</button>
        </div>
    </div>

    <div class="toast" id="toast">æ¶ˆæ¯æç¤º</div>

    <script>
        // --- æ ¸å¿ƒæ•°æ®ç»“æ„ ---
        const AppState = {
            words: [],
            progress: {},
            stats: { // æ¸¸æˆåŒ–æ•°æ®
                xp: 0,
                level: 1,
                coins: 0,
                streak: 0,
                lastStudyDate: ""
            },
            studyLog: {},
            settings: { darkMode: false, autoPlay: false },
            currentMode: 'flashcard',
            currentIndex: 0,
            reviewQueue: []
        };

        const FORGETTING_CURVE = [5, 30, 720, 1440, 2880, 5760, 10080, 21600, 43200]; // åˆ†é’Ÿ

        // --- åˆå§‹åŒ– ---
        async function init() {
            loadData();
            setupEventListeners();
            setupGestures();
            updateGamificationUI();
            renderHeatmap();
            applySettings();

            if (AppState.words.length === 0) await tryLoadDefault();
            else updateUI();
        }

        async function tryLoadDefault() {
            try {
                // å°è¯•åŠ è½½åŒç›®å½• c.txt
                const res = await fetch('c.txt');
                if(res.ok) {
                    const text = await res.text();
                    parseAndLoad(text);
                    showToast('ğŸ“š å·²è‡ªåŠ¨åŠ è½½ c.txt');
                } else {
                    document.getElementById('uploadModal').style.display = 'flex';
                }
            } catch(e) {
                // è·¨åŸŸæˆ–æ–‡ä»¶ä¸å­˜åœ¨
                document.getElementById('uploadModal').style.display = 'flex';
            }
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---
        function handleCardResult(known) {
            const w = getCurrentWord();
            if (!w) return;

            recordActivity();

            const p = AppState.progress[w.word] || { stage: 0 };
            const now = Date.now();

            if (known) {
                p.stage = Math.min((p.stage || 0) + 1, FORGETTING_CURVE.length);
                const mins = FORGETTING_CURVE[p.stage - 1];
                p.nextReview = now + mins * 60000;

                // ğŸ® æ¸¸æˆåŒ–å¥–åŠ±
                addRewards(10, 5);
                showToast(`ğŸ‘ è®°ä½å•¦ï¼+10XP +5ğŸª™`);
            } else {
                p.stage = p.stage > 4 ? 3 : 1; // æ™ºèƒ½é™çº§
                p.nextReview = now + FORGETTING_CURVE[p.stage - 1] * 60000;
                showToast('ğŸ’ª æ²¡å…³ç³»ï¼Œç¨åå†æ¥');
            }
            p.lastReview = now;
            AppState.progress[w.word] = p;

            saveData();

            if (AppState.currentMode === 'review') {
                AppState.reviewQueue.shift();
                if (AppState.reviewQueue.length > 0) {
                    AppState.currentIndex = AppState.reviewQueue[0];
                    renderCard();
                } else {
                    alert("ğŸ‰ å¤ä¹ å®Œæˆï¼");
                    confetti({ particleCount: 100, spread: 70 });
                    switchMode('flashcard');
                }
            } else {
                nextCard();
            }
        }

        // --- ğŸ® æ¸¸æˆåŒ–ç³»ç»Ÿ ---
        function addRewards(xp, coins) {
            if(!AppState.stats) AppState.stats = { xp: 0, level: 1, coins: 0, streak: 0, lastStudyDate: "" };

            AppState.stats.xp += xp;
            AppState.stats.coins += coins;

            // å‡çº§é€»è¾‘ï¼šæ¯çº§éœ€è¦ 100 * Level ç»éªŒ
            const needed = AppState.stats.level * 100;
            if (AppState.stats.xp >= needed) {
                AppState.stats.xp -= needed;
                AppState.stats.level++;
                showToast(`ğŸ†™ å‡çº§å•¦ï¼Lv.${AppState.stats.level}`);
                confetti({ particleCount: 150, spread: 100 });
            }
            updateGamificationUI();
        }

        function recordActivity() {
            if(!AppState.stats) AppState.stats = { xp: 0, level: 1, coins: 0, streak: 0, lastStudyDate: "" };
            const today = new Date().toDateString();
            if (AppState.stats.lastStudyDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (AppState.stats.lastStudyDate === yesterday.toDateString()) {
                    AppState.stats.streak++;
                } else {
                    AppState.stats.streak = 1; // æ–­ç­¾é‡ç½®æˆ–ç¬¬ä¸€å¤©
                }
                AppState.stats.lastStudyDate = today;
            }

            // çƒ­åŠ›å›¾è®°å½•
            const isoDate = new Date().toISOString().split('T')[0];
            if (!AppState.studyLog[isoDate]) AppState.studyLog[isoDate] = 0;
            AppState.studyLog[isoDate]++;
            renderHeatmap();
        }

        function updateGamificationUI() {
            if(!AppState.stats) return;
            document.getElementById('playerLevel').textContent = `Lv.${AppState.stats.level}`;
            document.getElementById('playerCoins').textContent = AppState.stats.coins;
            document.getElementById('playerStreak').textContent = AppState.stats.streak;
            document.getElementById('playerXp').textContent = AppState.stats.xp;

            const nextXp = AppState.stats.level * 100;
            document.getElementById('nextLevelXp').textContent = nextXp;
            const pct = (AppState.stats.xp / nextXp) * 100;
            document.getElementById('playerXpBar').style.width = `${pct}%`;
        }

        // --- UI æ¸²æŸ“ ---
        function renderCard() {
            const w = getCurrentWord();
            if (!w) return;

            // æ­£é¢
            document.getElementById('cardWord').textContent = w.word;
            document.getElementById('cardPhonetic').textContent = w.phonetic;

            // å¤ä¹ æç¤º
            const p = AppState.progress[w.word] || {stage: 0};
            let statusText = "";
            if (p.stage === 99) statusText = "ğŸ‘‘ å·²æ°¸ä¹…æŒæ¡";
            else if (p.stage === 0) statusText = "ğŸ†• æ–°å•è¯";
            else statusText = `ğŸ“ˆ é˜¶æ®µ: ${p.stage} | å¤ä¹ : ${formatTimeDiff(p.nextReview)}`;
            document.getElementById('cardNextReviewFront').textContent = statusText;
            document.getElementById('cardNextReviewBack').textContent = statusText;

            // èƒŒé¢
            document.getElementById('cardPos').textContent = w.pos || 'Word';
            document.getElementById('cardMeaning').textContent = w.meaning;
            document.getElementById('cardMemory').textContent = w.memory ? `ğŸ’¡ ${w.memory}` : '';

            // ğŸŒ å¤–éƒ¨è·³è½¬é“¾æ¥ (Context)
            const linkBox = document.getElementById('externalLinks');
            linkBox.innerHTML = `
                <a href="https://www.bing.com/images/search?q=${w.word}" target="_blank" class="link-chip" onclick="event.stopPropagation()"><i class="fas fa-image"></i> å›¾ç‰‡</a>
                <a href="https://dictionary.cambridge.org/dictionary/english/${w.word}" target="_blank" class="link-chip" onclick="event.stopPropagation()"><i class="fas fa-book"></i> è¯å…¸</a>
            `;

            // é‡ç½®çŠ¶æ€
            const card = document.querySelector('.flashcard');
            card.classList.remove('flipped');
            card.style.transform = '';

            // ğŸ”Š è‡ªåŠ¨å‘éŸ³
            if (AppState.settings.autoPlay) {
                setTimeout(() => speakWord(), 300);
            }

            highlightListItem();
            if(AppState.currentMode === 'quiz') renderQuiz();
            if(AppState.currentMode === 'spelling') renderSpelling();
        }

        // --- åŠŸèƒ½å‡½æ•° ---
        function exportData() {
            const blob = new Blob([JSON.stringify(AppState)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MemoryPro_Backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast('âœ… å¤‡ä»½å·²ä¸‹è½½');
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.words && data.progress) {
                        if(confirm('æ¢å¤å¤‡ä»½å°†è¦†ç›–å½“å‰è¿›åº¦ï¼Œç¡®å®šå—ï¼Ÿ')) {
                            Object.assign(AppState, data);
                            // å…¼å®¹æ—§ç‰ˆæ•°æ®
                            if(!AppState.stats) AppState.stats = { xp: 0, level: 1, coins: 0, streak: 0, lastStudyDate: "" };
                            saveData();
                            init();
                            showToast('âœ… æ¢å¤æˆåŠŸ');
                        }
                    } else alert('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶');
                } catch(e) { alert('è§£æå¤±è´¥'); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function parseAndLoad(text) {
            const lines = text.split(/\r?\n/);
            const newWords = [];
            lines.forEach(line => {
                if(!line.trim()) return;
                const parts = line.split('\t');
                const word = parts[0].trim();
                if(word) {
                    let phonetic = '', pos = '', meaning = '', memory = '';
                    if(parts[1]) {
                        const mid = parts[1].trim();
                        if(mid.includes('|')) {
                            const arr = mid.split('|');
                            phonetic = arr[0].trim();
                            const fullDef = arr[1].trim();
                            const match = fullDef.match(/^([a-z\.\/]+)\s+(.+)$/i);
                            if(match) { pos = match[1]; meaning = match[2]; }
                            else meaning = fullDef;
                        } else meaning = mid;
                    }
                    if(parts[2]) memory = parts[2].trim();
                    newWords.push({word, phonetic, pos, meaning, memory});
                }
            });
            AppState.words = newWords;
            AppState.progress = {}; // æ–°ä¹¦æ¸…ç©ºè¿›åº¦
            saveData();
            updateUI();
        }

        // --- è¾…åŠ©ä¸äº‹ä»¶ ---
        function saveData() {
            localStorage.setItem('memoryPro_data', JSON.stringify(AppState));
            updateStatsUI();
            updateGamificationUI();
        }
        function loadData() {
            const raw = localStorage.getItem('memoryPro_data');
            if(raw) {
                const data = JSON.parse(raw);
                // å…¼å®¹æ—§æ•°æ®
                if (!data.stats) data.stats = { xp: 0, level: 1, coins: 0, streak: 0, lastStudyDate: "" };
                Object.assign(AppState, data);
            }
        }
        function updateStatsUI() {
            const now = Date.now();
            let needReview = 0;
            AppState.words.forEach(w => {
                const p = AppState.progress[w.word];
                if(p && p.stage > 0 && p.stage < 99 && p.nextReview < now) needReview++;
            });
            const badge = document.getElementById('badgeReview');
            badge.style.display = needReview > 0 ? 'inline-block' : 'none';
            badge.textContent = needReview;
        }
        function renderHeatmap() {
            const grid = document.getElementById('heatmapGrid');
            grid.innerHTML = '';
            const today = new Date();
            for(let i=29; i>=0; i--) {
                const d = new Date();
                d.setDate(today.getDate() - i);
                const iso = d.toISOString().split('T')[0];
                const count = AppState.studyLog[iso] || 0;
                const div = document.createElement('div');
                div.className = 'heatmap-cell';
                if(count > 0) div.classList.add('level-1');
                if(count > 5) div.classList.add('level-2');
                if(count > 15) div.classList.add('level-3');
                if(count > 30) div.classList.add('level-4');
                div.title = `${iso}: ${count}`;
                grid.appendChild(div);
            }
        }
        function speakWord(e) {
            if(e) e.stopPropagation();
            const w = getCurrentWord();
            if(w) { const u = new SpeechSynthesisUtterance(w.word); u.lang = 'en-US'; speechSynthesis.speak(u); }
        }
        function getCurrentWord() { return AppState.words[AppState.currentIndex]; }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerHTML = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); }
        function nextCard() { if(AppState.currentIndex < AppState.words.length - 1) { AppState.currentIndex++; renderCard(); } else showToast('å·²æ˜¯æœ€åä¸€å¼ '); }
        function highlightListItem() {
            document.querySelectorAll('.list-item').forEach(e => e.classList.remove('active'));
            const item = document.getElementById(`list-item-${AppState.currentIndex}`);
            if(item) item.classList.add('active');
        }
        function formatTimeDiff(ts) { const d=ts-Date.now(); if(d<=0)return"ç°åœ¨"; const m=Math.floor(d/60000); if(m<60)return m+"åˆ†"; const h=Math.floor(m/60); if(h<24)return h+"æ—¶"; return Math.floor(h/24)+"å¤©"; }

        // æ¨¡å¼åˆ‡æ¢
        function switchMode(mode) {
            AppState.currentMode = mode;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.mode === mode));

            const ws = document.getElementById('workspace');
            document.getElementById('flashcardControls').style.display = (mode === 'flashcard' || mode === 'review') ? 'flex' : 'none';
            document.querySelector('.flashcard-container').style.display = (mode === 'flashcard' || mode === 'review') ? 'block' : 'none';
            document.getElementById('quizOverlay').style.display = mode === 'quiz' ? 'block' : 'none';
            document.getElementById('spellingOverlay').style.display = mode === 'spelling' ? 'block' : 'none';

            if(mode === 'review') {
                const now = Date.now();
                AppState.reviewQueue = AppState.words.map((w,i)=>({i, p:AppState.progress[w.word]})).filter(x => x.p && x.p.stage>0 && x.p.stage<99 && x.p.nextReview < now).map(x=>x.i);
                if(AppState.reviewQueue.length > 0) {
                    AppState.currentIndex = AppState.reviewQueue[0];
                    showToast(`å¤ä¹  ${AppState.reviewQueue.length} ä¸ªå•è¯`);
                } else {
                    alert('æš‚æ— å¤ä¹ ä»»åŠ¡'); switchMode('flashcard'); return;
                }
            }
            renderCard();
        }

        // äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            document.getElementById('settingsBtn').onclick = () => {
                document.getElementById('settingsModal').style.display = 'flex';
                document.getElementById('autoPlaySwitch').checked = AppState.settings.autoPlay;
                document.getElementById('darkModeSwitch').checked = AppState.settings.darkMode;
            };
            document.getElementById('autoPlaySwitch').onchange = (e) => { AppState.settings.autoPlay = e.target.checked; saveData(); };
            document.getElementById('darkModeSwitch').onchange = (e) => {
                AppState.settings.darkMode = e.target.checked;
                applySettings(); saveData();
            };

            document.querySelectorAll('.nav-item').forEach(el => el.onclick = () => switchMode(el.dataset.mode));

            document.querySelector('.flashcard-container').onclick = (e) => {
                if(!e.target.closest('button') && !e.target.closest('a')) document.querySelector('.flashcard').classList.toggle('flipped');
            };

            document.getElementById('btnNext').onclick = nextCard;
            document.getElementById('btnPrev').onclick = () => { if(AppState.currentIndex > 0) { AppState.currentIndex--; renderCard(); }};
            document.getElementById('btnKnown').onclick = () => handleCardResult(true);
            document.getElementById('btnUnknown').onclick = () => handleCardResult(false);
            document.getElementById('btnMaster').onclick = () => {
                 if(AppState.progress[getCurrentWord().word]) AppState.progress[getCurrentWord().word].stage=99;
                 addRewards(20, 10); // æŒæ¡å¥–åŠ±æ›´å¤š
                 saveData(); showToast('ğŸ‘‘ å·²æŒæ¡ +20XP'); confetti({particleCount:50});
            };

            document.getElementById('uploadBtn').onclick = () => document.getElementById('uploadModal').style.display='flex';
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            dropZone.onclick = () => fileInput.click();
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => { parseAndLoad(ev.target.result); document.getElementById('uploadModal').style.display='none'; };
                    reader.readAsText(file);
                }
            };

            document.getElementById('toggleSidebarBtn').onclick = () => document.getElementById('sidebar').classList.add('open');
            document.getElementById('closeSidebarBtn').onclick = () => document.getElementById('sidebar').classList.remove('open');
            document.addEventListener('keydown', (e) => {
                if(document.getElementById('settingsModal').style.display === 'flex') return;
                if(e.code==='Space') { e.preventDefault(); document.querySelector('.flashcard').classList.toggle('flipped'); }
                if(e.code==='ArrowRight') handleCardResult(true);
                if(e.code==='ArrowLeft') handleCardResult(false);
            });
        }

        function applySettings() {
            if(AppState.settings.darkMode) document.body.setAttribute('data-theme', 'dark');
            else document.body.removeAttribute('data-theme');
        }

        function setupGestures() {
            const el = document.querySelector('.flashcard-container');
            let startX = 0;
            el.addEventListener('touchstart', e => startX = e.touches[0].clientX, {passive:true});
            el.addEventListener('touchend', e => {
                const delta = e.changedTouches[0].clientX - startX;
                if(delta > 80) handleCardResult(true);
                if(delta < -80) handleCardResult(false);
            }, {passive:true});
        }

        function updateUI() {
            const list = document.getElementById('sidebarWordList');
            if(!list) { // åŠ¨æ€è¡¥å…¨åˆ—è¡¨å®¹å™¨
                const div = document.createElement('div');
                div.id = 'sidebarWordList';
                div.className = 'word-list-container';
                document.getElementById('sidebar').appendChild(div);
            }
            const container = document.getElementById('sidebarWordList');
            container.innerHTML = '';
            AppState.words.slice(0, 100).forEach((w, i) => {
                const d = document.createElement('div');
                d.className = 'list-item';
                d.style.padding='10px'; d.style.cursor='pointer'; d.style.borderBottom='1px solid var(--border)';
                d.id = `list-item-${i}`;
                d.textContent = w.word;
                d.onclick = () => { AppState.currentIndex = i; renderCard(); };
                container.appendChild(d);
            });
            renderCard();
        }

        // æµ‹éªŒä¸æ‹¼å†™
        function renderQuiz() {
            const w = getCurrentWord();
            document.getElementById('quizWord').textContent = w.word;
            const box = document.getElementById('quizOptions');
            box.innerHTML = '';
            const pool = AppState.words.filter(x => x.word !== w.word).sort(()=>Math.random()-0.5).slice(0,3);
            pool.push(w);
            pool.sort(()=>Math.random()-0.5).forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option';
                btn.textContent = opt.meaning;
                btn.onclick = () => {
                    if(opt.word===w.word) { btn.classList.add('correct'); addRewards(5,2); showToast('æ­£ç¡®'); setTimeout(nextCard,800); }
                    else { btn.classList.add('wrong'); showToast('é”™è¯¯'); }
                };
                box.appendChild(btn);
            });
        }
        function renderSpelling() {
            document.getElementById('spellingMeaning').textContent = getCurrentWord().meaning;
            document.getElementById('spellingInput').value = '';
            document.getElementById('spellingInput').focus();
            speakWord();
        }
        function checkSpelling() {
            if(document.getElementById('spellingInput').value.trim().toLowerCase() === getCurrentWord().word.toLowerCase()) {
                addRewards(10,5); showToast('æ­£ç¡®'); setTimeout(nextCard,800);
            } else showToast('é”™è¯¯');
        }
        function speakCurrentWord() { speakWord(); }

        init();
    </script>
</body>
</html>
